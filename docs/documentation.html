<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Documentation - ccap</title>
    <meta name="description" content="Complete documentation for the ccap cross-platform camera capture library.">
    <link rel="canonical" href="https://ccap.work/documentation.html">
    <link rel="stylesheet" href="css/style.css">
    <!-- marked.js for markdown rendering - using specific version for stability -->
    <script src="https://cdn.jsdelivr.net/npm/marked@9.1.6/marked.min.js" crossorigin="anonymous"></script>
    <!-- DOMPurify for HTML sanitization to prevent XSS -->
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js" crossorigin="anonymous"></script>
    <!-- Highlight.js for syntax highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/vs2015.min.css" crossorigin="anonymous">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/cpp.min.js" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/bash.min.js" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/shell.min.js" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/cmake.min.js" crossorigin="anonymous"></script>
</head>
<body>
    <header>
        <nav class="container">
            <a href="index.html" class="logo">ccap</a>
            <button class="mobile-menu-toggle" aria-label="Toggle menu">‚ò∞</button>
            <ul class="nav-links">
                <li><a href="index.html#download"><span class="lang-en">Download</span><span class="lang-zh">‰∏ãËΩΩ</span></a></li>
                <li><a href="index.html#features"><span class="lang-en">Features</span><span class="lang-zh">ÁâπÊÄß</span></a></li>
                <li><a href="index.html#quickstart"><span class="lang-en">Quick Start</span><span class="lang-zh">Âø´ÈÄüÂºÄÂßã</span></a></li>
                <li class="nav-dropdown">
                    <a href="documentation.html"><span class="lang-en">Documentation</span><span class="lang-zh">ÊñáÊ°£</span></a>
                    <ul class="dropdown-menu">
                        <li><a href="documentation.html?doc=c-interface"><span class="lang-en">C Interface</span><span class="lang-zh">C Êé•Âè£</span></a></li>
                        <li><a href="documentation.html?doc=implementation-details"><span class="lang-en">Implementation Details</span><span class="lang-zh">ÂÆûÁé∞ÁªÜËäÇ</span></a></li>
                        <li><a href="documentation.html?doc=video-memory-management"><span class="lang-en">Memory & Video Playback</span><span class="lang-zh">ÂÜÖÂ≠òÁÆ°ÁêÜ‰∏éËßÜÈ¢ëÊí≠Êîæ</span></a></li>
                        <li><a href="documentation.html?doc=cmake-options"><span class="lang-en">CMake Build Options</span><span class="lang-zh">CMake ÊûÑÂª∫ÈÄâÈ°π</span></a></li>
                    </ul>
                </li>
                <li><a href="documentation.html?doc=cli"><span class="lang-en">CLI Tool</span><span class="lang-zh">CLI Â∑•ÂÖ∑</span></a></li>
                <li><a href="https://github.com/wysaid/CameraCapture">GitHub</a></li>
                <li><button class="lang-switch" onclick="ccap.toggleLanguage()">üåê ‰∏≠Êñá</button></li>
            </ul>
        </nav>
    </header>

    <div class="doc-layout">
        <aside class="doc-sidebar" id="doc-sidebar" role="navigation" aria-label="Documentation navigation">
            <p class="lang-en">Loading navigation...</p>
            <p class="lang-zh">Ê≠£Âú®Âä†ËΩΩÂØºËà™...</p>
        </aside>

        <main class="doc-content" id="doc-content">
            <div class="doc-loading">
                <p class="lang-en">Loading documentation...</p>
                <p class="lang-zh">Ê≠£Âú®Âä†ËΩΩÊñáÊ°£...</p>
            </div>
        </main>
    </div>

    <footer>
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h4 class="lang-en">Download</h4>
                    <h4 class="lang-zh">‰∏ãËΩΩ</h4>
                    <ul>
                        <li><a href="https://github.com/wysaid/CameraCapture/releases"><span class="lang-en">Releases</span><span class="lang-zh">ÁâàÊú¨ÂèëÂ∏É</span></a></li>
                        <li><a href="https://github.com/wysaid/CameraCapture/releases/latest"><span class="lang-en">Latest Release</span><span class="lang-zh">ÊúÄÊñ∞ÁâàÊú¨</span></a></li>
                    </ul>
                </div>
                
                <div class="footer-section">
                    <h4 class="lang-en">Documentation</h4>
                    <h4 class="lang-zh">ÊñáÊ°£</h4>
                    <ul>
                        <li><a href="documentation.html"><span class="lang-en">Main Documentation</span><span class="lang-zh">‰∏ªÊñáÊ°£</span></a></li>
                        <li><a href="documentation.html?doc=cli"><span class="lang-en">CLI Tool</span><span class="lang-zh">CLI Â∑•ÂÖ∑</span></a></li>
                        <li><a href="documentation.html?doc=c-interface"><span class="lang-en">C Interface</span><span class="lang-zh">C Êé•Âè£</span></a></li>
                        <li><a href="documentation.html?doc=implementation-details"><span class="lang-en">Implementation Details</span><span class="lang-zh">ÂÆûÁé∞ÁªÜËäÇ</span></a></li>
                        <li><a href="documentation.html?doc=video-memory-management"><span class="lang-en">Memory Management</span><span class="lang-zh">ÂÜÖÂ≠òÁÆ°ÁêÜ</span></a></li>
                        <li><a href="documentation.html?doc=cmake-options"><span class="lang-en">CMake Options</span><span class="lang-zh">CMake ÈÄâÈ°π</span></a></li>
                    </ul>
                </div>
                
                <div class="footer-section">
                    <h4 class="lang-en">Community</h4>
                    <h4 class="lang-zh">Á§æÂå∫</h4>
                    <ul>
                        <li><a href="https://github.com/wysaid/CameraCapture">GitHub</a></li>
                        <li><a href="https://github.com/wysaid/CameraCapture/issues">Issues</a></li>
                        <li><a href="https://github.com/wysaid/CameraCapture/pulls">Pull Requests</a></li>
                    </ul>
                </div>
                
                <div class="footer-section">
                    <h4 class="lang-en">License</h4>
                    <h4 class="lang-zh">ËÆ∏ÂèØËØÅ</h4>
                    <ul>
                        <li><a href="https://github.com/wysaid/CameraCapture/blob/main/LICENSE">MIT License</a></li>
                        <li>¬© 2025 Wang Yang</li>
                    </ul>
                </div>
            </div>
            
            <div class="footer-bottom">
                <p>ccap - Cross-Platform Camera Capture Library</p>
            </div>
        </div>
    </footer>

    <script src="js/main.js"></script>
    <script>
        (function() {
            // Configure marked.js with sanitization options
            if (typeof marked !== 'undefined') {
                marked.setOptions({
                    breaks: true,
                    gfm: true,
                    highlight: function(code, lang) {
                        // Don't highlight here, let hljs do it after sanitization
                        return code;
                    }
                });
            }

            // Get the current language
            function getCurrentLang() {
                return document.documentElement.getAttribute('lang') || 'en';
            }

            // Debounce utility to prevent excessive calls
            function debounce(func, wait) {
                var timeout;
                return function() {
                    var context = this;
                    var args = arguments;
                    clearTimeout(timeout);
                    timeout = setTimeout(function() {
                        func.apply(context, args);
                    }, wait);
                };
            }

            // Sanitize HTML to prevent XSS attacks
            function sanitizeHtml(html) {
                if (typeof DOMPurify !== 'undefined') {
                    return DOMPurify.sanitize(html, {
                        ALLOWED_TAGS: ['h1', 'h2', 'h3', 'h4', 'h5', 'h6', 'p', 'br', 'hr', 
                                       'ul', 'ol', 'li', 'pre', 'code', 'blockquote',
                                       'table', 'thead', 'tbody', 'tr', 'th', 'td',
                                       'a', 'strong', 'em', 'del', 'img', 'span', 'div'],
                        ALLOWED_ATTR: ['href', 'src', 'alt', 'title', 'class', 'id'],
                        KEEP_CONTENT: true,
                        ALLOW_DATA_ATTR: false
                    });
                }
                // Fallback: return as-is if DOMPurify not available
                return html;
            }

            // Convert markdown file links to HTML page links
            function convertMarkdownLinksToHtml(html) {
                var tempDiv = document.createElement('div');
                tempDiv.innerHTML = html;
                
                // Find all links
                var links = tempDiv.querySelectorAll('a[href]');
                links.forEach(function(link) {
                    var href = link.getAttribute('href');
                    
                    // Skip external links, anchors, and already-converted links
                    if (!href || href.startsWith('http://') || href.startsWith('https://') || 
                        href.startsWith('#') || href.includes('documentation.html')) {
                        return;
                    }
                    
                    // Convert .md links to HTML page links
                    if (href.endsWith('.md')) {
                        var filename = href.split('/').pop(); // Get filename
                        var baseName = filename.replace(/\.zh\.md$/, '').replace(/\.md$/, '');
                        
                        // Map filenames to appropriate URLs
                        if (baseName === 'documentation') {
                            link.setAttribute('href', 'documentation.html');
                        } else if (baseName === 'cli') {
                            link.setAttribute('href', 'documentation.html?doc=cli');
                        } else if (baseName === 'c-interface') {
                            link.setAttribute('href', 'documentation.html?doc=c-interface');
                        } else if (baseName === 'implementation-details') {
                            link.setAttribute('href', 'documentation.html?doc=implementation-details');
                        } else if (baseName === 'video-memory-management') {
                            link.setAttribute('href', 'documentation.html?doc=video-memory-management');
                        } else if (baseName === 'cmake-options') {
                            link.setAttribute('href', 'documentation.html?doc=cmake-options');
                        } else {
                            // Generic conversion for any other .md files
                            link.setAttribute('href', 'documentation.html?doc=' + baseName);
                        }
                    }
                });
                
                return tempDiv.innerHTML;
            }

            // Fetch and render markdown documentation
            function loadDocumentation() {
                var lang = getCurrentLang();
                
                // Check for ?doc= query parameter
                var urlParams = new URLSearchParams(window.location.search);
                var docName = urlParams.get('doc');
                
                var primaryFile, fallbackFile;
                if (docName) {
                    // Remove any existing language suffix from docName
                    var baseDocName = docName.endsWith('.zh') ? docName.replace('.zh', '') : docName;
                    
                    // Load document based on current interface language, not URL suffix
                    if (lang === 'zh') {
                        primaryFile = 'content/' + baseDocName + '.zh.md';
                        fallbackFile = 'content/' + baseDocName + '.md';
                    } else {
                        primaryFile = 'content/' + baseDocName + '.md';
                        fallbackFile = 'content/documentation.md';
                    }
                } else {
                    // Default to main documentation
                    primaryFile = lang === 'zh' ? 'content/documentation.zh.md' : 'content/documentation.md';
                    fallbackFile = 'content/documentation.md';
                }
                
                fetch(primaryFile)
                    .then(function(response) {
                        if (!response.ok && lang === 'zh') {
                            // Fallback to English if Chinese version not found
                            return fetch(fallbackFile);
                        }
                        if (!response.ok) {
                            throw new Error('Failed to load documentation');
                        }
                        return response;
                    })
                    .then(function(response) {
                        return response.text();
                    })
                    .then(function(markdown) {
                        // Render markdown to HTML using marked.js and sanitize
                        var rawHtml = marked.parse(markdown);
                        var safeHtml = sanitizeHtml(rawHtml);
                        
                        // Convert .md links to HTML page links
                        var htmlWithConvertedLinks = convertMarkdownLinksToHtml(safeHtml);
                        
                        document.getElementById('doc-content').innerHTML = htmlWithConvertedLinks;
                        
                        // Apply syntax highlighting to code blocks
                        // Use setTimeout to ensure DOM is fully updated
                        setTimeout(function() {
                            if (typeof hljs !== 'undefined') {
                                var codeBlocks = document.querySelectorAll('#doc-content pre code');
                                console.log('Found ' + codeBlocks.length + ' code blocks to highlight');
                                codeBlocks.forEach(function(block) {
                                    console.log('Highlighting block with class:', block.className);
                                    hljs.highlightElement(block);
                                });
                            } else {
                                console.error('hljs is not loaded!');
                            }
                        }, 0);
                        
                        // Generate sidebar navigation from headings
                        generateSidebar();
                        
                        // Initialize scroll spy
                        initScrollSpy();
                        
                        // Handle anchor navigation after content is loaded
                        handleAnchorNavigation();
                    })
                    .catch(function(error) {
                        console.error('Error loading documentation:', error);
                        var messageEn = 'Failed to load documentation. Please try again later.';
                        var messageZh = 'Âä†ËΩΩÊñáÊ°£Â§±Ë¥•ÔºåËØ∑Á®çÂêéÈáçËØï„ÄÇ';
                        
                        if (error && error.name === 'TypeError' && error.message.includes('Failed to fetch')) {
                            messageEn = 'Network error - please check your internet connection.';
                            messageZh = 'ÁΩëÁªúÈîôËØØ - ËØ∑Ê£ÄÊü•ÊÇ®ÁöÑÁΩëÁªúËøûÊé•„ÄÇ';
                        }
                        
                        document.getElementById('doc-content').innerHTML = 
                            '<p class="lang-en">' + messageEn + ' <a href="https://github.com/wysaid/CameraCapture/blob/main/README.md">View on GitHub</a></p>' +
                            '<p class="lang-zh">' + messageZh + ' <a href="https://github.com/wysaid/CameraCapture/blob/main/README.zh-CN.md">Âú® GitHub ‰∏äÊü•Áúã</a></p>';
                    });
            }

            // Generate slugified ID from heading text for stable anchor links
            function slugify(text) {
                if (!text) return '';
                return text
                    .toLowerCase()
                    .trim()
                    .replace(/[^\w\s\u4E00-\u9FFF-]/g, '') // Support Chinese characters (U+4E00 to U+9FFF)
                    .replace(/\s+/g, '-')
                    .replace(/-+/g, '-');
            }

            // Simple HTML escaping
            function escapeHtml(text) {
                var div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            // Generate sidebar navigation from h2 and h3 headings
            function generateSidebar() {
                var content = document.getElementById('doc-content');
                var sidebar = document.getElementById('doc-sidebar');
                var headings = content.querySelectorAll('h2, h3');
                
                if (headings.length === 0) {
                    sidebar.innerHTML = '<p>No sections found</p>';
                    return;
                }

                var html = '';
                var currentH2 = null;
                
                headings.forEach(function(heading) {
                    // Generate stable ID from heading text
                    if (!heading.id) {
                        heading.id = slugify(heading.textContent);
                    }
                    
                    // Ensure ID is not empty
                    if (!heading.id) {
                        heading.id = 'heading-' + Math.random().toString(36).substr(2, 9);
                    }
                    
                    var text = heading.textContent;
                    var id = heading.id;
                    
                    if (heading.tagName === 'H2') {
                        if (currentH2) {
                            html += '</ul>';
                        }
                        // H2 as a clickable category title
                        html += '<h3><a href="#' + escapeHtml(id) + '">' + escapeHtml(text) + '</a></h3>';
                        html += '<ul>';
                        currentH2 = heading;
                    } else if (heading.tagName === 'H3') {
                        // H3 as a list item link
                        html += '<li><a href="#' + escapeHtml(id) + '">' + escapeHtml(text) + '</a></li>';
                    }
                });
                
                if (currentH2) {
                    html += '</ul>';
                }
                
                sidebar.innerHTML = html;
            }

            // Initialize scroll spy for sidebar
            function initScrollSpy() {
                var headings = document.querySelectorAll('#doc-content h2, #doc-content h3');
                var sidebarLinks = document.querySelectorAll('#doc-sidebar a');
                
                function updateActiveLink() {
                    var scrollY = window.scrollY;
                    var currentHeading = null;
                    
                    headings.forEach(function(heading) {
                        var rect = heading.getBoundingClientRect();
                        if (rect.top <= 100) {
                            currentHeading = heading;
                        }
                    });
                    
                    sidebarLinks.forEach(function(link) {
                        link.classList.remove('active');
                        if (currentHeading && link.getAttribute('href') === '#' + currentHeading.id) {
                            link.classList.add('active');
                        }
                    });
                }
                
                window.addEventListener('scroll', updateActiveLink);
                updateActiveLink();
            }

            // Handle anchor navigation when URL hash changes
            function handleAnchorNavigation() {
                var hash = window.location.hash.substr(1); // Remove the # symbol
                if (hash) {
                    var targetElement = document.getElementById(decodeURIComponent(hash));
                    if (targetElement) {
                        // Scroll to the target element with a small delay to ensure DOM is ready
                        setTimeout(function() {
                            targetElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        }, 50);
                    }
                }
            }

            // Listen for hash changes (when clicking anchor links)
            window.addEventListener('hashchange', handleAnchorNavigation);

            // Debounced version of loadDocumentation to prevent excessive calls
            var debouncedLoadDocumentation = debounce(loadDocumentation, 100);

            // Listen for language changes with debouncing
            var observer = new MutationObserver(function(mutations) {
                var langChanged = mutations.some(function(mutation) {
                    return mutation.type === 'attributes' && mutation.attributeName === 'lang';
                });
                if (langChanged) {
                    debouncedLoadDocumentation();
                }
            });
            
            observer.observe(document.documentElement, {
                attributes: true,
                attributeFilter: ['lang']
            });

            // Load documentation on page load
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', loadDocumentation);
            } else {
                loadDocumentation();
            }
        })();
    </script>
</body>
</html>
